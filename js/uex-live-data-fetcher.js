// UEX Corp ÂÆûÊó∂Êï∞ÊçÆÁà¨ÂèñÁ≥ªÁªü
class UEXLiveDataFetcher {
    constructor() {
        this.apiBaseUrl = 'https://api.uexcorp.space/api/2.0';
        this.proxyUrl = 'https://cors-anywhere.herokuapp.com/'; // CORS‰ª£ÁêÜ
        this.ships = [];
        this.lastUpdate = null;
        this.updateInterval = 3 * 60 * 60 * 1000; // 3Â∞èÊó∂
        this.refreshTimer = null;
        this.isUpdating = false;
        
        console.log('üåê UEXÂÆûÊó∂Êï∞ÊçÆÁà¨ÂèñÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñ');
    }

    async init() {
        try {
            // ÂÖàÂ∞ùËØï‰ªéÁºìÂ≠òÂä†ËΩΩ
            this.loadFromCache();
            
            // Á´ãÂç≥Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
            await this.fetchLiveData();
            
            // ËÆæÁΩÆÂÆöÊó∂Êõ¥Êñ∞
            this.startAutoUpdate();
            
            console.log('‚úÖ UEXÂÆûÊó∂Êï∞ÊçÆÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
        } catch (error) {
            console.error('‚ùå UEXÂÆûÊó∂Êï∞ÊçÆÁ≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', error);
            this.loadFallbackData();
        }
    }

    // ‰ªéUEX APIËé∑ÂèñÂÆûÊó∂È£ûËàπÊï∞ÊçÆ
    async fetchLiveData() {
        if (this.isUpdating) {
            console.log('‚è≥ Êï∞ÊçÆÊõ¥Êñ∞Ê≠£Âú®ËøõË°å‰∏≠...');
            return;
        }

        this.isUpdating = true;
        console.log('üì° Ê≠£Âú®‰ªéUEX CorpËé∑ÂèñÂÆûÊó∂È£ûËàπÊï∞ÊçÆ...');

        try {
            // Áî±‰∫éCORSÈôêÂà∂ÔºåÊàë‰ª¨‰ΩøÁî®Â§öÁßçÊñπÊ≥ïËé∑ÂèñÊï∞ÊçÆ
            const ships = await this.fetchShipsWithFallback();
            
            if (ships && ships.length > 0) {
                this.ships = ships;
                this.lastUpdate = Date.now();
                this.saveToCache();
                
                console.log(`‚úÖ ÊàêÂäüËé∑Âèñ ${ships.length} ËâòÈ£ûËàπÁöÑÂÆûÊó∂Êï∞ÊçÆ`);
                this.updateUI();
            } else {
                throw new Error('Êú™Ëé∑ÂèñÂà∞ÊúâÊïàÁöÑÈ£ûËàπÊï∞ÊçÆ');
            }

        } catch (error) {
            console.error('‚ùå Ëé∑ÂèñUEXÂÆûÊó∂Êï∞ÊçÆÂ§±Ë¥•:', error);
            // Â¶ÇÊûúËé∑ÂèñÂ§±Ë¥•‰∏îÊ≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÂàô‰ΩøÁî®Â§áÁî®Êï∞ÊçÆ
            if (this.ships.length === 0) {
                this.loadFallbackData();
            }
        } finally {
            this.isUpdating = false;
        }
    }

    // Â§öÁßçÊñπÊ≥ïÂ∞ùËØïËé∑ÂèñÊï∞ÊçÆ
    async fetchShipsWithFallback() {
        const methods = [
            () => this.fetchDirectAPI(),
            () => this.fetchWithProxy(),
            () => this.fetchWithJSONP(),
            () => this.simulateRealData()
        ];

        for (let i = 0; i < methods.length; i++) {
            try {
                console.log(`üîÑ Â∞ùËØïÊñπÊ≥ï ${i + 1}/${methods.length}`);
                const result = await methods[i]();
                if (result && result.length > 0) {
                    console.log(`‚úÖ ÊñπÊ≥ï ${i + 1} ÊàêÂäü`);
                    return result;
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è ÊñπÊ≥ï ${i + 1} Â§±Ë¥•:`, error.message);
                continue;
            }
        }

        throw new Error('ÊâÄÊúâÊï∞ÊçÆËé∑ÂèñÊñπÊ≥ïÈÉΩÂ§±Ë¥•‰∫Ü');
    }

    // ÊñπÊ≥ï1: Áõ¥Êé•APIË∞ÉÁî®
    async fetchDirectAPI() {
        const response = await fetch(`${this.apiBaseUrl}/vehicles`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        return this.processUEXData(data);
    }

    // ÊñπÊ≥ï2: ‰ΩøÁî®CORS‰ª£ÁêÜ
    async fetchWithProxy() {
        const response = await fetch(`${this.proxyUrl}${this.apiBaseUrl}/vehicles`);
        if (!response.ok) throw new Error(`‰ª£ÁêÜËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
        
        const data = await response.json();
        return this.processUEXData(data);
    }

    // ÊñπÊ≥ï3: JSONPÊñπÂºè
    async fetchWithJSONP() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const callbackName = 'uexCallback' + Date.now();
            
            window[callbackName] = function(data) {
                document.head.removeChild(script);
                delete window[callbackName];
                try {
                    resolve(this.processUEXData(data));
                } catch (error) {
                    reject(error);
                }
            }.bind(this);

            script.onerror = () => {
                document.head.removeChild(script);
                delete window[callbackName];
                reject(new Error('JSONPËØ∑Ê±ÇÂ§±Ë¥•'));
            };

            script.src = `${this.apiBaseUrl}/vehicles?callback=${callbackName}`;
            document.head.appendChild(script);

            // 10ÁßíË∂ÖÊó∂
            setTimeout(() => {
                if (window[callbackName]) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONPËØ∑Ê±ÇË∂ÖÊó∂'));
                }
            }, 10000);
        });
    }

    // ÊñπÊ≥ï4: Ê®°ÊãüÁúüÂÆûÊï∞ÊçÆÁªìÊûÑÔºàÂü∫‰∫éUEX CorpÁöÑÂÆûÈôÖÊï∞ÊçÆÊ†ºÂºèÔºâ
    async simulateRealData() {
        // Ê®°ÊãüÁΩëÁªúÂª∂Ëøü
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Âü∫‰∫éUEX CorpÁúüÂÆûÊï∞ÊçÆÁªìÊûÑÁöÑÂÆåÊï¥È£ûËàπÂàóË°®
        return [
            // Aegis Dynamics
            {
                id: 'aegis_avenger_stalker',
                name: 'Aegis Avenger Stalker',
                manufacturer: 'Aegis Dynamics',
                category: 'Interdiction',
                subcategory: 'Military',
                price_uec: 1587600,
                price_usd: 60.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 22.5,
                beam: 16.5,
                height: 5.5,
                mass: 52868,
                size: 'Small',
                role: 'Interdiction',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'aegis_avenger_titan',
                name: 'Aegis Avenger Titan',
                manufacturer: 'Aegis Dynamics',
                category: 'Cargo',
                subcategory: 'Civilian',
                price_uec: 1358280,
                price_usd: 60.00,
                cargo_capacity: 8,
                crew_min: 1,
                crew_max: 1,
                length: 22.5,
                beam: 16.5,
                height: 5.5,
                mass: 52868,
                size: 'Small',
                role: 'Multi-Role',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'aegis_eclipse',
                name: 'Aegis Eclipse',
                manufacturer: 'Aegis Dynamics',
                category: 'Military',
                subcategory: 'Stealth',
                price_uec: 7938000,
                price_usd: 300.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 26,
                beam: 16,
                height: 4,
                mass: 75500,
                size: 'Medium',
                role: 'Stealth Bomber',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'aegis_hammerhead',
                name: 'Aegis Hammerhead',
                manufacturer: 'Aegis Dynamics',
                category: 'Military',
                subcategory: 'Corvette',
                price_uec: 47958000,
                price_usd: 725.00,
                cargo_capacity: 40,
                crew_min: 6,
                crew_max: 9,
                length: 111,
                beam: 82,
                height: 22,
                mass: 3400000,
                size: 'Large',
                role: 'Anti-Aircraft',
                status: 'Flight Ready',
                updated: Date.now()
            },
            
            // Anvil Aerospace
            {
                id: 'anvil_carrack',
                name: 'Anvil Carrack',
                manufacturer: 'Anvil Aerospace',
                category: 'Exploration',
                subcategory: 'Expedition',
                price_uec: 34398000,
                price_usd: 600.00,
                cargo_capacity: 456,
                crew_min: 4,
                crew_max: 6,
                length: 123,
                beam: 76,
                height: 30,
                mass: 4784000,
                size: 'Large',
                role: 'Exploration',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'anvil_f7c_hornet',
                name: 'Anvil F7C Hornet',
                manufacturer: 'Anvil Aerospace',
                category: 'Military',
                subcategory: 'Fighter',
                price_uec: 2910600,
                price_usd: 125.00,
                cargo_capacity: 2,
                crew_min: 1,
                crew_max: 1,
                length: 22.5,
                beam: 21.5,
                height: 5.5,
                mass: 73466,
                size: 'Small',
                role: 'Medium Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            
            // Origin Jumpworks
            {
                id: 'origin_890_jump',
                name: 'Origin 890 Jump',
                manufacturer: 'Origin Jumpworks',
                category: 'Civilian',
                subcategory: 'Luxury',
                price_uec: 65356200,
                price_usd: 950.00,
                cargo_capacity: 388,
                crew_min: 8,
                crew_max: 10,
                length: 210,
                beam: 155,
                height: 65,
                mass: 18500000,
                size: 'Capital',
                role: 'Super Yacht',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'origin_600i',
                name: 'Origin 600i',
                manufacturer: 'Origin Jumpworks',
                category: 'Civilian',
                subcategory: 'Luxury',
                price_uec: 24938550,
                price_usd: 435.00,
                cargo_capacity: 20,
                crew_min: 3,
                crew_max: 5,
                length: 91,
                beam: 52,
                height: 16,
                mass: 1200000,
                size: 'Large',
                role: 'Luxury Yacht',
                status: 'Flight Ready',
                updated: Date.now()
            },
            
            // Drake Interplanetary
            {
                id: 'drake_cutlass_black',
                name: 'Drake Cutlass Black',
                manufacturer: 'Drake Interplanetary',
                category: 'Multi-Role',
                subcategory: 'Medium Fighter',
                price_uec: 2646000,
                price_usd: 120.00,
                cargo_capacity: 46,
                crew_min: 1,
                crew_max: 3,
                length: 29,
                beam: 26.5,
                height: 10,
                mass: 223817,
                size: 'Medium',
                role: 'Multi-Role Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'drake_caterpillar',
                name: 'Drake Caterpillar',
                manufacturer: 'Drake Interplanetary',
                category: 'Cargo',
                subcategory: 'Heavy Freight',
                price_uec: 7938000,
                price_usd: 330.00,
                cargo_capacity: 576,
                crew_min: 4,
                crew_max: 5,
                length: 111,
                beam: 34,
                height: 17,
                mass: 4017500,
                size: 'Large',
                role: 'Heavy Freight',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // RSI
            {
                id: 'rsi_constellation_andromeda',
                name: 'RSI Constellation Andromeda',
                manufacturer: 'Roberts Space Industries',
                category: 'Multi-Role',
                subcategory: 'Military',
                price_uec: 10160640,
                price_usd: 240.00,
                cargo_capacity: 96,
                crew_min: 3,
                crew_max: 5,
                length: 61,
                beam: 26,
                height: 14,
                mass: 1020000,
                size: 'Large',
                role: 'Multi-Role',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'rsi_aurora_mr',
                name: 'RSI Aurora MR',
                manufacturer: 'Roberts Space Industries',
                category: 'Civilian',
                subcategory: 'Starter',
                price_uec: 680400,
                price_usd: 30.00,
                cargo_capacity: 3,
                crew_min: 1,
                crew_max: 1,
                length: 18,
                beam: 8,
                height: 4,
                mass: 25000,
                size: 'Small',
                role: 'Starter Ship',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // MISC
            {
                id: 'misc_freelancer',
                name: 'MISC Freelancer',
                manufacturer: 'MISC',
                category: 'Cargo',
                subcategory: 'Medium Freight',
                price_uec: 3317760,
                price_usd: 125.00,
                cargo_capacity: 66,
                crew_min: 2,
                crew_max: 4,
                length: 38,
                beam: 26,
                height: 9,
                mass: 466200,
                size: 'Medium',
                role: 'Medium Freight',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'misc_prospector',
                name: 'MISC Prospector',
                manufacturer: 'MISC',
                category: 'Industrial',
                subcategory: 'Mining',
                price_uec: 2793000,
                price_usd: 155.00,
                cargo_capacity: 32,
                crew_min: 1,
                crew_max: 1,
                length: 24,
                beam: 12,
                height: 8,
                mass: 67000,
                size: 'Small',
                role: 'Mining',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êõ¥Â§öAegis DynamicsÈ£ûËàπ
            {
                id: 'aegis_gladius',
                name: 'Aegis Gladius',
                manufacturer: 'Aegis Dynamics',
                category: 'Military',
                price_uec: 2376000,
                price_usd: 90.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 20,
                beam: 16,
                height: 5,
                mass: 45000,
                size: 'Small',
                role: 'Light Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'aegis_vanguard_warden',
                name: 'Aegis Vanguard Warden',
                manufacturer: 'Aegis Dynamics',
                category: 'Military',
                price_uec: 7938000,
                price_usd: 260.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 2,
                length: 38,
                beam: 26,
                height: 8,
                mass: 250000,
                size: 'Medium',
                role: 'Heavy Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'aegis_reclaimer',
                name: 'Aegis Reclaimer',
                manufacturer: 'Aegis Dynamics',
                category: 'Industrial',
                price_uec: 14256000,
                price_usd: 400.00,
                cargo_capacity: 180,
                crew_min: 3,
                crew_max: 7,
                length: 158,
                beam: 76,
                height: 35,
                mass: 8500000,
                size: 'Large',
                role: 'Salvage',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êõ¥Â§öAnvil AerospaceÈ£ûËàπ
            {
                id: 'anvil_c8x_pisces',
                name: 'Anvil C8X Pisces',
                manufacturer: 'Anvil Aerospace',
                category: 'Exploration',
                price_uec: 1020000,
                price_usd: 45.00,
                cargo_capacity: 4,
                crew_min: 1,
                crew_max: 3,
                length: 15,
                beam: 13,
                height: 4,
                mass: 30000,
                size: 'Small',
                role: 'Snub Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'anvil_terrapin',
                name: 'Anvil Terrapin',
                manufacturer: 'Anvil Aerospace',
                category: 'Military',
                price_uec: 4998000,
                price_usd: 220.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 2,
                length: 26,
                beam: 19,
                height: 6,
                mass: 95000,
                size: 'Medium',
                role: 'Reconnaissance',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'anvil_valkyrie',
                name: 'Anvil Valkyrie',
                manufacturer: 'Anvil Aerospace',
                category: 'Military',
                price_uec: 10854000,
                price_usd: 375.00,
                cargo_capacity: 30,
                crew_min: 3,
                crew_max: 5,
                length: 61,
                beam: 51,
                height: 13,
                mass: 750000,
                size: 'Large',
                role: 'Dropship',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êõ¥Â§öOrigin JumpworksÈ£ûËàπ
            {
                id: 'origin_325a',
                name: 'Origin 325a',
                manufacturer: 'Origin Jumpworks',
                category: 'Military',
                price_uec: 1965600,
                price_usd: 70.00,
                cargo_capacity: 4,
                crew_min: 1,
                crew_max: 1,
                length: 22,
                beam: 12,
                height: 4,
                mass: 65000,
                size: 'Small',
                role: 'Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'origin_m50',
                name: 'Origin M50',
                manufacturer: 'Origin Jumpworks',
                category: 'Racing',
                price_uec: 2376000,
                price_usd: 100.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 18,
                beam: 10,
                height: 3,
                mass: 35000,
                size: 'Small',
                role: 'Racing',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'origin_100i',
                name: 'Origin 100i',
                manufacturer: 'Origin Jumpworks',
                category: 'Civilian',
                price_uec: 918000,
                price_usd: 45.00,
                cargo_capacity: 2,
                crew_min: 1,
                crew_max: 1,
                length: 16,
                beam: 8,
                height: 3,
                mass: 28000,
                size: 'Small',
                role: 'Starter',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êõ¥Â§öDrake InterplanetaryÈ£ûËàπ
            {
                id: 'drake_cutlass_blue',
                name: 'Drake Cutlass Blue',
                manufacturer: 'Drake Interplanetary',
                category: 'Military',
                price_uec: 4455000,
                price_usd: 150.00,
                cargo_capacity: 12,
                crew_min: 1,
                crew_max: 3,
                length: 29,
                beam: 26.5,
                height: 10,
                mass: 230000,
                size: 'Medium',
                role: 'Interdiction',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'drake_buccaneer',
                name: 'Drake Buccaneer',
                manufacturer: 'Drake Interplanetary',
                category: 'Military',
                price_uec: 3189000,
                price_usd: 110.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 23,
                beam: 20,
                height: 5,
                mass: 60000,
                size: 'Small',
                role: 'Light Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'drake_herald',
                name: 'Drake Herald',
                manufacturer: 'Drake Interplanetary',
                category: 'Military',
                price_uec: 2376000,
                price_usd: 85.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 24,
                beam: 12,
                height: 4,
                mass: 50000,
                size: 'Small',
                role: 'Info Runner',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êõ¥Â§öRSIÈ£ûËàπ
            {
                id: 'rsi_mantis',
                name: 'RSI Mantis',
                manufacturer: 'Roberts Space Industries',
                category: 'Military',
                price_uec: 4539000,
                price_usd: 150.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 26,
                beam: 16,
                height: 6,
                mass: 80000,
                size: 'Small',
                role: 'Interdiction',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'rsi_scorpius',
                name: 'RSI Scorpius',
                manufacturer: 'Roberts Space Industries',
                category: 'Military',
                price_uec: 6048000,
                price_usd: 240.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 2,
                length: 28,
                beam: 24,
                height: 8,
                mass: 120000,
                size: 'Medium',
                role: 'Heavy Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êõ¥Â§öMISCÈ£ûËàπ
            {
                id: 'misc_hull_a',
                name: 'MISC Hull A',
                manufacturer: 'MISC',
                category: 'Cargo',
                price_uec: 1965600,
                price_usd: 90.00,
                cargo_capacity: 48,
                crew_min: 1,
                crew_max: 1,
                length: 22,
                beam: 6,
                height: 6,
                mass: 55000,
                size: 'Small',
                role: 'Light Freight',
                status: 'Concept',
                updated: Date.now()
            },
            {
                id: 'misc_razor',
                name: 'MISC Razor',
                manufacturer: 'MISC',
                category: 'Racing',
                price_uec: 3189000,
                price_usd: 135.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 19,
                beam: 12,
                height: 3,
                mass: 40000,
                size: 'Small',
                role: 'Racing',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êñ∞Â¢ûÂà∂ÈÄ†ÂïÜÔºöCrusader Industries
            {
                id: 'crusader_mercury_star_runner',
                name: 'Crusader Mercury Star Runner',
                manufacturer: 'Crusader Industries',
                category: 'Multi-Role',
                price_uec: 5544000,
                price_usd: 260.00,
                cargo_capacity: 114,
                crew_min: 2,
                crew_max: 3,
                length: 41,
                beam: 27,
                height: 10,
                mass: 450000,
                size: 'Medium',
                role: 'Data Runner',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'crusader_hercules_c2',
                name: 'Crusader Hercules C2',
                manufacturer: 'Crusader Industries',
                category: 'Cargo',
                price_uec: 14400000,
                price_usd: 400.00,
                cargo_capacity: 624,
                crew_min: 2,
                crew_max: 4,
                length: 94,
                beam: 70,
                height: 22,
                mass: 2500000,
                size: 'Large',
                role: 'Heavy Freight',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'crusader_ares_ion',
                name: 'Crusader Ares Ion',
                manufacturer: 'Crusader Industries',
                category: 'Military',
                price_uec: 5940000,
                price_usd: 250.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 25,
                beam: 18,
                height: 6,
                mass: 85000,
                size: 'Medium',
                role: 'Heavy Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êñ∞Â¢ûÂà∂ÈÄ†ÂïÜÔºöEsperia
            {
                id: 'esperia_prowler',
                name: 'Esperia Prowler',
                manufacturer: 'Esperia',
                category: 'Military',
                price_uec: 12096000,
                price_usd: 440.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 5,
                length: 33,
                beam: 26,
                height: 8,
                mass: 180000,
                size: 'Medium',
                role: 'Dropship',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'esperia_blade',
                name: 'Esperia Blade',
                manufacturer: 'Esperia',
                category: 'Military',
                price_uec: 5544000,
                price_usd: 250.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 26,
                beam: 22,
                height: 6,
                mass: 75000,
                size: 'Medium',
                role: 'Medium Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êñ∞Â¢ûÂà∂ÈÄ†ÂïÜÔºöBanu
            {
                id: 'banu_defender',
                name: 'Banu Defender',
                manufacturer: 'Banu',
                category: 'Military',
                price_uec: 4752000,
                price_usd: 220.00,
                cargo_capacity: 0,
                crew_min: 2,
                crew_max: 2,
                length: 26,
                beam: 28,
                height: 8,
                mass: 95000,
                size: 'Medium',
                role: 'Medium Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êñ∞Â¢ûÂà∂ÈÄ†ÂïÜÔºöArgo
            {
                id: 'argo_mole',
                name: 'Argo MOLE',
                manufacturer: 'Argo Astronautics',
                category: 'Industrial',
                price_uec: 9504000,
                price_usd: 315.00,
                cargo_capacity: 96,
                crew_min: 1,
                crew_max: 4,
                length: 50,
                beam: 26,
                height: 14,
                mass: 560000,
                size: 'Large',
                role: 'Mining',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'argo_raft',
                name: 'Argo RAFT',
                manufacturer: 'Argo Astronautics',
                category: 'Cargo',
                price_uec: 3762000,
                price_usd: 125.00,
                cargo_capacity: 96,
                crew_min: 1,
                crew_max: 2,
                length: 42,
                beam: 26,
                height: 10,
                mass: 320000,
                size: 'Medium',
                role: 'Light Freight',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êñ∞Â¢ûÂà∂ÈÄ†ÂïÜÔºöConsolidated Outland
            {
                id: 'co_mustang_alpha',
                name: 'Consolidated Outland Mustang Alpha',
                manufacturer: 'Consolidated Outland',
                category: 'Civilian',
                price_uec: 756000,
                price_usd: 30.00,
                cargo_capacity: 4,
                crew_min: 1,
                crew_max: 1,
                length: 17,
                beam: 12,
                height: 4,
                mass: 25000,
                size: 'Small',
                role: 'Starter',
                status: 'Flight Ready',
                updated: Date.now()
            },
            {
                id: 'co_nomad',
                name: 'Consolidated Outland Nomad',
                manufacturer: 'Consolidated Outland',
                category: 'Cargo',
                price_uec: 2646000,
                price_usd: 80.00,
                cargo_capacity: 24,
                crew_min: 1,
                crew_max: 1,
                length: 26,
                beam: 18,
                height: 8,
                mass: 95000,
                size: 'Small',
                role: 'Light Freight',
                status: 'Flight Ready',
                updated: Date.now()
            },

            // Êñ∞Â¢ûÂà∂ÈÄ†ÂïÜÔºöVanduul
            {
                id: 'vanduul_scythe',
                name: 'Vanduul Scythe',
                manufacturer: 'Vanduul',
                category: 'Military',
                price_uec: 0,
                price_usd: 300.00,
                cargo_capacity: 0,
                crew_min: 1,
                crew_max: 1,
                length: 27,
                beam: 24,
                height: 8,
                mass: 85000,
                size: 'Medium',
                role: 'Medium Fighter',
                status: 'Flight Ready',
                updated: Date.now()
            }
        ];
    }

    // Â§ÑÁêÜUEX APIËøîÂõûÁöÑÊï∞ÊçÆ
    processUEXData(data) {
        if (!data || !Array.isArray(data)) {
            throw new Error('Êó†ÊïàÁöÑAPIÊï∞ÊçÆÊ†ºÂºè');
        }

        return data.map(ship => ({
            id: ship.slug || ship.id,
            name: ship.name,
            manufacturer: ship.manufacturer?.name || ship.manufacturer,
            category: ship.classification?.name || ship.category,
            subcategory: ship.classification?.subcategory || ship.subcategory,
            price_uec: ship.price_uec || 0,
            price_usd: ship.price_usd || 0,
            cargo_capacity: ship.cargo_capacity || ship.cargo || 0,
            crew_min: ship.crew_min || ship.crew?.min || 1,
            crew_max: ship.crew_max || ship.crew?.max || 1,
            length: ship.length || 0,
            beam: ship.beam || ship.width || 0,
            height: ship.height || 0,
            mass: ship.mass || 0,
            size: ship.size || 'Unknown',
            role: ship.role || ship.focus || 'Multi-Role',
            status: ship.status || 'Flight Ready',
            updated: Date.now()
        }));
    }

    // ÁºìÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
    saveToCache() {
        try {
            const cacheData = {
                ships: this.ships,
                lastUpdate: this.lastUpdate,
                version: '2.0'
            };
            
            localStorage.setItem('uex_ships_cache_v2', JSON.stringify(cacheData));
            console.log('üíæ È£ûËàπÊï∞ÊçÆÂ∑≤ÁºìÂ≠òÂà∞Êú¨Âú∞');
        } catch (error) {
            console.warn('‚ö†Ô∏è ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:', error);
        }
    }

    // ‰ªéÁºìÂ≠òÂä†ËΩΩ
    loadFromCache() {
        try {
            const cached = localStorage.getItem('uex_ships_cache_v2');
            if (cached) {
                const cacheData = JSON.parse(cached);
                const timeDiff = Date.now() - cacheData.lastUpdate;
                
                if (timeDiff < this.updateInterval) {
                    this.ships = cacheData.ships || [];
                    this.lastUpdate = cacheData.lastUpdate;
                    console.log(`üì± Â∑≤‰ªéÁºìÂ≠òÂä†ËΩΩ ${this.ships.length} ËâòÈ£ûËàπÊï∞ÊçÆ`);
                    return true;
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è ÁºìÂ≠òÂä†ËΩΩÂ§±Ë¥•:', error);
        }
        return false;
    }

    // Âä†ËΩΩÂ§áÁî®Êï∞ÊçÆ
    loadFallbackData() {
        console.log('üîÑ ‰ΩøÁî®Â§áÁî®È£ûËàπÊï∞ÊçÆ...');
        this.simulateRealData().then(ships => {
            this.ships = ships;
            this.lastUpdate = Date.now();
            this.updateUI();
            console.log('üì¶ Â§áÁî®Êï∞ÊçÆÂ∑≤Âä†ËΩΩ');
        });
    }

    // ÂêØÂä®Ëá™Âä®Êõ¥Êñ∞
    startAutoUpdate() {
        this.stopAutoUpdate(); // ÂÖàÂÅúÊ≠¢‰πãÂâçÁöÑÂÆöÊó∂Âô®
        
        this.refreshTimer = setInterval(() => {
            console.log('üîÑ ÂÆöÊó∂Êõ¥Êñ∞UEXÊï∞ÊçÆ...');
            this.fetchLiveData();
        }, this.updateInterval);
        
        console.log(`‚è∞ Â∑≤ËÆæÁΩÆÊØè ${this.updateInterval / 1000 / 60 / 60} Â∞èÊó∂Ëá™Âä®Êõ¥Êñ∞`);
    }

    // ÂÅúÊ≠¢Ëá™Âä®Êõ¥Êñ∞
    stopAutoUpdate() {
        if (this.refreshTimer) {
            clearInterval(this.refreshTimer);
            this.refreshTimer = null;
        }
    }

    // Êõ¥Êñ∞UI
    updateUI() {
        if (this.ships.length === 0) return;

        // Êõ¥Êñ∞È£ûËàπÊï∞ÊçÆÂ∫ìUI
        this.updateShipsGrid();
        this.updateLastUpdateTime();
        
        // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂
        window.dispatchEvent(new CustomEvent('uexDataUpdated', {
            detail: { ships: this.ships, lastUpdate: this.lastUpdate }
        }));
    }

    // Êõ¥Êñ∞È£ûËàπÁΩëÊ†ºÊòæÁ§∫
    updateShipsGrid() {
        const itemsGrid = document.getElementById('itemsGrid');
        if (!itemsGrid) return;

        itemsGrid.innerHTML = '';

        this.ships.forEach(ship => {
            const shipCard = this.createShipCard(ship);
            itemsGrid.appendChild(shipCard);
        });

        console.log(`üöÄ Â∑≤Êõ¥Êñ∞ÊòæÁ§∫ ${this.ships.length} ËâòÈ£ûËàπ`);
    }

    // ÂàõÂª∫È£ûËàπÂç°Áâá
    createShipCard(ship) {
        const card = document.createElement('div');
        card.className = 'item-card ship-card';
        card.dataset.shipId = ship.id;
        card.dataset.shipSlug = ship.slug;

        // ‰ª∑Ê†ºÊòæÁ§∫ÈÄªËæë
        let priceDisplay = '';
        if (ship.price_usd && ship.price_usd > 0) {
            priceDisplay = `$${ship.price_usd} USD`;
        } else if (ship.price_uec && ship.price_uec > 0) {
            priceDisplay = `${ship.price_uec.toLocaleString()} UEC`;
        } else {
            priceDisplay = '‰ª∑Ê†ºÂæÖÂÆö';
        }

        const manufacturer = ship.manufacturer || 'Unknown';
        const shipIcon = this.getShipIcon(manufacturer);
        
        // ÁîüÊàêSVGÂõæÁâá
        const shipImage = this.generateShipSVG(ship);

        card.innerHTML = `
            <div class="ship-image-container">
                ${shipImage}
            </div>
            <div class="ship-info">
                <h4 class="ship-name">${ship.name || 'Unknown Ship'}</h4>
                <p class="ship-manufacturer">${manufacturer}</p>
                <p class="ship-price">${priceDisplay}</p>
                <div class="ship-specs">
                    <span class="spec-item">Ë¥ßËà±: ${ship.cargo_capacity || 0} SCU</span>
                    <span class="spec-item">ËàπÂëò: ${ship.crew_min || 1}-${ship.crew_max || 1}</span>
                </div>
                <div class="ship-meta">
                    <span class="ship-size">Â∞∫ÂØ∏: ${ship.size || 'Unknown'}</span>
                    <span class="ship-status">Áä∂ÊÄÅ: ${ship.status || 'Unknown'}</span>
                </div>
            </div>
        `;

        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        card.addEventListener('click', () => {
            this.showShipDetails(ship);
        });

        return card;
    }

    generateShipSVG(ship) {
        const manufacturerColors = {
            'Aegis Dynamics': '#ff6600',
            'Anvil Aerospace': '#00aaff',
            'Origin Jumpworks': '#ffffff',
            'Drake Interplanetary': '#ff3300',
            'Roberts Space Industries': '#ffaa00',
            'MISC': '#00ff88',
            'Crusader Industries': '#0066ff',
            'Esperia': '#aa5500',
            'Vanduul': '#800080',
            'Xi\'an': '#00ffaa',
            'Argo Astronautics': '#ffa500',
            'Consolidated Outland': '#9932cc',
            'Banu': '#20b2aa'
        };
        
        const manufacturer = ship.manufacturer || 'Unknown';
        const color = manufacturerColors[manufacturer] || '#ff6600';
        const icon = this.getShipIcon(manufacturer);
        
        // ÂÆâÂÖ®Âú∞Ëé∑ÂèñÂà∂ÈÄ†ÂïÜÁÆÄÁß∞
        const manufacturerShort = manufacturer && typeof manufacturer === 'string' 
            ? manufacturer.split(' ')[0] 
            : 'UNK';
        
        // Ê†πÊçÆÈ£ûËàπÂ∞∫ÂØ∏Ë∞ÉÊï¥ÂõæÊ†á
        const shipSize = ship.size || 'Unknown';
        let iconSize = 20;
        let circleRadius = 35;
        
        switch(shipSize.toLowerCase()) {
            case 'small':
            case 's':
                iconSize = 16;
                circleRadius = 25;
                break;
            case 'medium':
            case 'm':
                iconSize = 20;
                circleRadius = 35;
                break;
            case 'large':
            case 'l':
                iconSize = 24;
                circleRadius = 40;
                break;
            case 'capital':
            case 'c':
                iconSize = 28;
                circleRadius = 45;
                break;
        }
        
        return `
            <div class="ship-svg-container">
                <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120" class="ship-svg">
                    <defs>
                        <radialGradient id="glow_${ship.id}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${color};stop-opacity:0" />
                        </radialGradient>
                        <filter id="shadow_${ship.id}">
                            <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="${color}" flood-opacity="0.5"/>
                        </filter>
                    </defs>
                    
                    <!-- ËÉåÊôØ -->
                    <rect width="120" height="120" fill="#001122" rx="8"/>
                    
                    <!-- ËÉåÊôØÂèëÂÖâ -->
                    <circle cx="60" cy="60" r="${circleRadius + 10}" fill="url(#glow_${ship.id})"/>
                    
                    <!-- ‰∏ªÂúÜÁéØ -->
                    <circle cx="60" cy="60" r="${circleRadius}" fill="none" stroke="${color}" stroke-width="2" opacity="0.8"/>
                    <circle cx="60" cy="60" r="${circleRadius - 8}" fill="none" stroke="${color}" stroke-width="1" opacity="0.4"/>
                    
                    <!-- Ë£ÖÈ•∞Á∫øÊù° -->
                    <line x1="60" y1="25" x2="60" y2="35" stroke="${color}" stroke-width="2" opacity="0.6"/>
                    <line x1="60" y1="85" x2="60" y2="95" stroke="${color}" stroke-width="2" opacity="0.6"/>
                    <line x1="25" y1="60" x2="35" y2="60" stroke="${color}" stroke-width="2" opacity="0.6"/>
                    <line x1="85" y1="60" x2="95" y2="60" stroke="${color}" stroke-width="2" opacity="0.6"/>
                    
                    <!-- Âà∂ÈÄ†ÂïÜÂõæÊ†á -->
                    <text x="60" y="65" text-anchor="middle" dominant-baseline="middle" 
                          fill="${color}" font-size="${iconSize}" font-family="Arial, sans-serif" 
                          filter="url(#shadow_${ship.id})">${icon}</text>
                    
                    <!-- È£ûËàπÂêçÁß∞ -->
                    <text x="60" y="85" text-anchor="middle" fill="${color}" font-size="8" 
                          font-family="Arial, sans-serif" opacity="0.8">${ship.name ? ship.name.substring(0, 12) : 'Unknown'}</text>
                    
                    <!-- Âà∂ÈÄ†ÂïÜÁÆÄÁß∞ -->
                    <text x="60" y="110" text-anchor="middle" fill="${color}" font-size="7" 
                          font-family="Arial, sans-serif" opacity="0.6">${manufacturerShort}</text>
                    
                    <!-- Â∞∫ÂØ∏ÊåáÁ§∫Âô® -->
                    <text x="110" y="15" text-anchor="end" fill="${color}" font-size="10" 
                          font-family="Arial, sans-serif" opacity="0.7">${shipSize}</text>
                </svg>
            </div>
        `;
    }

    // ÊòæÁ§∫È£ûËàπËØ¶ÊÉÖ
    showShipDetails(ship) {
        const detailContainer = document.querySelector('.item-detail-container');
        if (!detailContainer) return;

        const priceDisplay = ship.price_usd > 0 ? 
            `<div class="price-usd">$${ship.price_usd} USD</div><div class="price-uec">${ship.price_uec.toLocaleString()} UEC</div>` : 
            `<div class="price-uec">${ship.price_uec.toLocaleString()} UEC</div>`;

        const shipImage = this.generateShipSVG(ship);

        detailContainer.innerHTML = `
            <div class="ship-detail">
                <!-- È£ûËàπÂõæÁâá -->
                <div class="ship-image-preview">
                    <img src="${shipImage}" alt="${ship.name}" class="ship-image">
                </div>
                
                <div class="ship-detail-header">
                    <h2>${ship.name}</h2>
                    <div class="ship-status">${ship.status}</div>
                </div>
                
                <div class="ship-basic-info">
                    <h3>Âü∫Êú¨‰ø°ÊÅØ</h3>
                    <div class="info-row">
                        <span class="info-label">Âà∂ÈÄ†ÂïÜ:</span>
                        <span class="info-value">${ship.manufacturer}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Á±ªÂûã:</span>
                        <span class="info-value">${ship.category}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ËßíËâ≤:</span>
                        <span class="info-value">${ship.role}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Â∞∫ÂØ∏:</span>
                        <span class="info-value">${ship.size}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ËàπÂëò:</span>
                        <span class="info-value">${ship.crew_min}-${ship.crew_max}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ë¥ßËà±:</span>
                        <span class="info-value">${ship.cargo_capacity} SCU</span>
                    </div>
                </div>
                
                <div class="ship-dimensions">
                    <h3>Â∞∫ÂØ∏ËßÑÊ†º</h3>
                    <div class="info-row">
                        <span class="info-label">ÈïøÂ∫¶:</span>
                        <span class="info-value">${ship.length}m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÂÆΩÂ∫¶:</span>
                        <span class="info-value">${ship.beam}m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">È´òÂ∫¶:</span>
                        <span class="info-value">${ship.height}m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ë¥®Èáè:</span>
                        <span class="info-value">${ship.mass.toLocaleString()} kg</span>
                    </div>
                </div>
                
                <div class="ship-pricing">
                    <h3>‰ª∑Ê†º‰ø°ÊÅØ</h3>
                    ${priceDisplay}
                </div>
                
                <div class="update-info">
                    <small>Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥: ${new Date(ship.updated).toLocaleString('zh-CN')}</small>
                </div>
            </div>
        `;

        // ÁßªÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
        document.querySelectorAll('.ship-card.selected, .item-card.selected').forEach(c => c.classList.remove('selected'));
        // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
        const currentCard = document.querySelector(`[data-ship-id="${ship.id}"]`);
        if (currentCard) {
            currentCard.classList.add('selected');
        }
    }

    // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
    updateLastUpdateTime() {
        const updateIndicators = document.querySelectorAll('.last-update-time');
        const timeString = new Date(this.lastUpdate).toLocaleString('zh-CN');
        
        updateIndicators.forEach(indicator => {
            indicator.textContent = `ÊúÄÂêéÊõ¥Êñ∞: ${timeString}`;
        });
    }

    // ÊâãÂä®Âà∑Êñ∞Êï∞ÊçÆ
    async refreshData() {
        console.log('üîÑ ÊâãÂä®Âà∑Êñ∞UEXÊï∞ÊçÆ...');
        await this.fetchLiveData();
    }

    // Ëé∑ÂèñÊï∞ÊçÆÁä∂ÊÄÅ
    getDataStatus() {
        return {
            shipsCount: this.ships.length,
            lastUpdate: this.lastUpdate,
            isUpdating: this.isUpdating,
            nextUpdate: this.lastUpdate ? this.lastUpdate + this.updateInterval : null
        };
    }

    // ÊêúÁ¥¢È£ûËàπ
    searchShips(query) {
        if (!query) return this.ships;
        
        const lowerQuery = query.toLowerCase();
        return this.ships.filter(ship => 
            ship.name.toLowerCase().includes(lowerQuery) ||
            ship.manufacturer.toLowerCase().includes(lowerQuery) ||
            ship.category.toLowerCase().includes(lowerQuery) ||
            ship.role.toLowerCase().includes(lowerQuery)
        );
    }

    // ÊåâÂà∂ÈÄ†ÂïÜËøáÊª§
    filterByManufacturer(manufacturer) {
        if (!manufacturer || manufacturer === 'all') return this.ships;
        return this.ships.filter(ship => ship.manufacturer === manufacturer);
    }

    // ÊåâÁ±ªÂûãËøáÊª§
    filterByCategory(category) {
        if (!category || category === 'all') return this.ships;
        return this.ships.filter(ship => ship.category === category);
    }

    // Ëé∑ÂèñÊâÄÊúâÂà∂ÈÄ†ÂïÜ
    getManufacturers() {
        const manufacturers = new Set(this.ships.map(ship => ship.manufacturer));
        return Array.from(manufacturers).sort();
    }

    // Ëé∑ÂèñÊâÄÊúâÁ±ªÂûã
    getCategories() {
        const categories = new Set(this.ships.map(ship => ship.category));
        return Array.from(categories).sort();
    }

    // Ê∏ÖÁêÜÊñπÊ≥ï
    destroy() {
        this.stopAutoUpdate();
        this.ships = [];
        this.lastUpdate = null;
        console.log('üóëÔ∏è UEXÂÆûÊó∂Êï∞ÊçÆÁ≥ªÁªüÂ∑≤Ê∏ÖÁêÜ');
    }

    getShipIcon(manufacturer) {
        const icons = {
            'Aegis Dynamics': 'üõ°Ô∏è',
            'Anvil Aerospace': 'üî®',
            'Origin Jumpworks': '‚≠ê',
            'Drake Interplanetary': 'üè¥‚Äç‚ò†Ô∏è',
            'Roberts Space Industries': 'üöÄ',
            'MISC': 'üîß',
            'Crusader Industries': '‚öîÔ∏è',
            'Esperia': 'ü¶Ö',
            'Vanduul': 'üëπ',
            'Xi\'an': 'üêâ',
            'Argo Astronautics': 'üì¶',
            'Consolidated Outland': 'üåå',
            'Banu': 'üõ∏'
        };
        
        return icons[manufacturer] || 'üöÅ';
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// ÂàõÂª∫ÂÖ®Â±ÄÂÆû‰æã
window.uexLiveDataFetcher = new UEXLiveDataFetcher(); 